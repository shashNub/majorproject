{% extends 'layout.html' %} {% block content %}
<style>
  .prose h1,
  .prose h2,
  .prose h3 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: bold;
    color: #1e40af;
  }
  .prose ul {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    list-style-type: disc;
    padding-left: 1.5em;
  }
  .prose li {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
  }
  .prose strong {
    color: #1e40af;
    font-weight: 600;
  }
  .prose p {
    margin-bottom: 0.75em;
  }
  .prose hr {
    margin: 1em 0;
    border-color: #e5e7eb;
  }
  .prose .date {
    color: #dc2626;
    font-weight: 600;
  }
</style>
<div class="max-w-4xl mx-auto p-4 text-gray-900 dark:text-gray-100">
  <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-100 dark:border-gray-700">
    <h1 class="text-2xl font-bold text-blue-700 dark:text-blue-400 mb-6">
      Government Jobs Assistant
    </h1>

    <!-- Chat Container -->
    <div
      id="chat-container"
      class="h-[500px] overflow-y-auto mb-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-900"
    >
      <div id="chat-messages" class="space-y-4">
        <div class="flex items-start mb-4">
          <div class="bg-blue-100 dark:bg-gray-800 dark:text-gray-100 rounded-lg p-3 max-w-[80%]">
            <p class="text-sm">
              Hello! I'm your Government Jobs Assistant. Ask me anything about
              Indian government jobs!
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Form -->
    <form id="chat-form" class="flex gap-2">
      <input
        type="text"
        id="user-input"
        class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Ask about government jobs..."
        required
      />
      <button
        type="submit"
        class="bg-blue-700 hover:bg-blue-800 text-white px-6 py-2 rounded-lg transition"
      >
        Send
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const initialMessage = "{{ initial_message|escapejs }}";

    if (initialMessage) {
      // Automatically send the initial query
      sendMessage(initialMessage);
    }
  });

  async function sendMessage(message) {
    // Don't show user message if it's the initial automatic query
    if (!document.querySelector(".loading-message")) {
      addMessage(message, "user");
    }

    addMessage("Analyzing job details...", "assistant", "loading-message");

    try {
      const response = await fetch('{% url "chatbot" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: `message=${encodeURIComponent(message)}`,
      });

      const data = await response.json();
      document.querySelector(".loading-message")?.remove();
      addMessage(data.response, "assistant");
    } catch (error) {
      document.querySelector(".loading-message")?.remove();
      addMessage(
        "Sorry, I encountered an error. Please try again.",
        "assistant"
      );
    }
  }

  document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const input = document.getElementById("user-input");
    const message = input.value;
    input.value = "";

    // Add user message to chat
    addMessage(message, "user");

    // Show loading indicator
    addMessage("Thinking...", "assistant", "loading-message");

    try {
      const response = await fetch("/chatbot/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: `message=${encodeURIComponent(message)}`,
      });

      const data = await response.json();

      // Remove loading message
      document.querySelector(".loading-message")?.remove();

      // Add assistant's response
      addMessage(data.response, "assistant");
    } catch (error) {
      document.querySelector(".loading-message")?.remove();
      addMessage(
        "Sorry, I encountered an error. Please try again.",
        "assistant"
      );
    }
  });

  function addMessage(message, sender, className = "") {
    const chatMessages = document.getElementById("chat-messages");
    const messageDiv = document.createElement("div");
    messageDiv.className = `flex items-start mb-4 ${className} ${
      sender === "user" ? "justify-end" : ""
    }`;

    const bubble = document.createElement("div");
    bubble.className =
      sender === "user"
        ? "bg-blue-600 text-white rounded-lg p-3 max-w-[80%]"
        : "bg-blue-100 dark:bg-gray-800 dark:text-gray-100 rounded-lg p-3 max-w-[80%] prose prose-sm";

    if (sender === "assistant") {
      // Remove empty lines and lines with "N/A" or empty values
      let lines = message.split("\n").filter((line) => {
        if (!line.trim()) return false;
        if (line.includes(":")) {
          const value = line.split(":")[1].trim();
          return value && value !== "N/A" && value !== "-";
        }
        return true;
      });

      let formattedMessage = lines.join("\n");

      // Convert ** to bold tags
      formattedMessage = formattedMessage.replace(
        /\*\*(.*?)\*\*/g,
        "<strong>$1</strong>"
      );

      // Convert * to list items (only if the line has content)
      formattedMessage = formattedMessage.replace(
        /\* (.*?)(?=\n|$)/g,
        (match, p1) => {
          return p1.trim() ? `<li>${p1}</li>` : "";
        }
      );

      // Wrap lists in ul tags (only if there are list items)
      if (formattedMessage.includes("<li>")) {
        formattedMessage =
          '<ul class="list-disc ml-4 my-2">' + formattedMessage + "</ul>";
      }

      // Add line breaks
      formattedMessage = formattedMessage.replace(/\n/g, "<br>");

      bubble.innerHTML = formattedMessage;
    } else {
      bubble.textContent = message;
    }

    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
