{% extends 'layout.html' %}
{% block content %}
<div class="max-w-md mx-auto mt-12 bg-white dark:bg-gray-900 rounded-2xl shadow-xl p-8 border border-blue-100 dark:border-gray-700">
  <h1 class="text-2xl font-bold text-blue-700 mb-4">Verify your email</h1>
  <p class="text-gray-600 dark:text-gray-300 mb-6">We'll send a verification link to {{ email }}.</p>
  <div id="status" class="text-sm text-gray-600 dark:text-gray-300">Preparingâ€¦</div>
</div>
<script>
  // Firebase config from server settings
  const firebaseConfig = {{ firebase_config|safe }};
</script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script>
  // Use Firebase config from server
  const cfg = firebaseConfig;
  (async function run(){
    const status = document.getElementById('status');
    try {
      if (!cfg || !cfg.apiKey) {
        status.textContent = 'Firebase config missing. Set FIREBASE_* env vars.';
        return;
      }
      firebase.initializeApp(cfg);
      const auth = firebase.auth();

      // Create or sign in a Firebase user with the same email (passwordless draft: random temp password)
      const email = '{{ email }}';
      if (!email) { status.textContent = 'No email on file.'; return; }

      let userCred;
      try { userCred = await auth.createUserWithEmailAndPassword(email, 'TempPassw0rd!'); }
      catch { userCred = await auth.signInWithEmailAndPassword(email, 'TempPassw0rd!'); }

      await userCred.user.sendEmailVerification({ url: window.location.origin + '/users/firebase/verify-email' });
      status.textContent = 'Verification email sent. Check your inbox and click the link.';
    } catch (e) {
      document.getElementById('status').textContent = 'Error: ' + e;
    }
  })();
</script>
{% endblock content %}

